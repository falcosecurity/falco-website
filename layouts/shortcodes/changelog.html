{{- $releases_url := (.Get 0) -}}
{{- $gh_project_repo := ($.Site.Param "github_project_repo") -}}
{{- $dataJSON := false }}

{{- $headers := dict -}}
{{- with $github_token := (os.Getenv "HUGO_GITHUB_TOKEN" | default false ) -}}
  {{- $headers = dict "Authorization" (printf "Bearer %s" .) -}}
{{- end -}}

{{- with try (resources.GetRemote $releases_url (dict "headers" $headers)) -}}
  {{- with .Err -}}
    {{- errorf "Error fetching GitHub API: %s" . -}}
  {{- else with .Value -}}
    {{- $dataJSON = . | transform.Unmarshal -}}
  {{- end -}}
{{- else -}}
  {{- errorf "Unable to fetch remote resource %q" $releases_url -}}
{{- end }}

{{ with $dataJSON }}
<div class="changelog">
    {{- $separator := false -}}

    {{- range $release := $dataJSON }}

        {{- with $separator }} {{/* No separator before the first entry */}}
            {{ . | markdownify }}
        {{- end }}

        <div class="changelog-item">
            <h2 class="title is-size-3 is-size-4-mobile">
              {{- with .tag_name -}}
                  {{- $link := printf "%s/tree/%s" $gh_project_repo . -}}
                  Version <a href="{{ $link }}" target="_blank">{{ . }}</a>
              {{- end -}}
            </h2>

            <div class="changelog-item-content content">
              <h3 class="title is-size-3 is-size-4-mobile">Download</h3>
              {{ .body | markdownify }}
            </div>
        </div>

        {{- $separator = "<hr />" -}}
    {{- end -}}
</div>
{{ else }}
  {{ $.Page.Scratch.Set "github_error" true }}
{{ end }}
